#!/bin/sh
set -e

echo "ğŸ” Pre-commit checks running..."
echo ""

# 1. Check and format staged files with Biome
echo "ğŸ“ Checking code quality with Biome..."

# Store the list of staged files before Biome modifies them
STAGED_FILES=$(git diff --cached --name-only)

if ! bun run check; then
  echo "âŒ Biome check failed. Please fix the errors above."
  exit 1
fi

# Re-stage only the files that were originally staged (preserving developer intent)
if [ -n "$STAGED_FILES" ]; then
  echo "ğŸ“¦ Re-staging formatted files..."
  printf '%s\n' "$STAGED_FILES" | while IFS= read -r file; do
    if [ -n "$file" ] && [ -e "$file" ]; then
      git add "$file"
    fi
  done
fi

echo "âœ… Biome check passed and files re-staged"
echo ""

# 2. Run TypeScript type checking
echo "ğŸ” Type checking..."
if ! bunx tsc --noEmit; then
  echo "âŒ TypeScript errors found. Please fix them above."
  exit 1
fi
echo "âœ… TypeScript check passed"
echo ""

# 3. Run tests
echo "ğŸ§ª Running tests..."
if ! bun run test | tail -n 4; then
  echo "âŒ Tests failed. Please fix the errors above."
  exit 1
fi
echo "âœ… All tests passed"
echo ""

echo "âœ¨ All pre-commit checks passed! Ready to commit."
