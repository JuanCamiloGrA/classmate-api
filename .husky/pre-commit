#!/bin/sh
set -e

echo "🔍 Pre-commit checks running..."
echo ""

# 1. Check and format staged files with Biome
echo "📝 Checking code quality with Biome..."

# Store the list of staged files before Biome modifies them
STAGED_FILES=$(git diff --cached --name-only)

if ! bun run check; then
  echo "❌ Biome check failed. Please fix the errors above."
  exit 1
fi

# Re-stage only the files that were originally staged (preserving developer intent)
if [ -n "$STAGED_FILES" ]; then
  echo "📦 Re-staging formatted files..."
  printf '%s\n' "$STAGED_FILES" | while IFS= read -r file; do
    if [ -n "$file" ] && [ -e "$file" ]; then
      git add "$file"
    fi
  done
fi

echo "✅ Biome check passed and files re-staged"
echo ""

# 2. Run TypeScript type checking
echo "🔐 Type checking..."
if ! bunx tsc --noEmit; then
  echo "❌ TypeScript errors found. Please fix them above."
  exit 1
fi
echo "✅ TypeScript check passed"
echo ""

# 3. Run tests
echo "🧪 Running tests..."
if ! bun run test | tail -n 4; then
  echo "❌ Tests failed. Please fix the errors above."
  exit 1
fi
echo "✅ All tests passed"
echo ""

echo "✨ All pre-commit checks passed! Ready to commit."
