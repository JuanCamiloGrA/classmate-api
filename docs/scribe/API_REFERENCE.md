# Scribe API Reference (v2)

This document describes the Scribe v2 backend API and the required client workflow.

## Core Concepts

- Scribe is **iterative**: the client calls `POST /scribe` multiple times.
- Each call returns either:
  - a **form schema** (needs more info), or
  - the **final result** (R2 key + exam).
- **Important**: URLs to R2 files are NOT stored in the database. Clients must request presigned URLs on-demand using dedicated endpoints.
- For any `image_file` field in a form, the client must:
  1) request a presigned upload URL
  2) upload the image to R2
  3) answer with `file_route` (the R2 key)

## Authentication

All endpoints below require Clerk auth (Bearer token), except the Clerk webhook profile creation.

## R2 Storage Key Standard

All new uploads generated by this API follow `docs/R2_STORAGE_GUIDE.md`.

---

## Profiles: Scribe Style References (2 slots)

Scribe supports 2 persistent style reference files stored in the user profile.

### 1) Generate presigned upload URL for a style slot

**POST** `/profiles/me/scribe-style/upload-url`

Request body:

```json
{
  "slot": 1,
  "fileName": "style-example.pdf",
  "contentType": "application/pdf"
}
```

Response (200):

```json
{
  "signedUrl": "https://...",
  "file_route": "users/<userId>/rubrics/2025/10/<uuid>-scribe-style-slot-1-style-example.pdf"
}
```

Client steps:
- `PUT signedUrl` with `Content-Type: contentType`
- then call `PUT /profiles/me/scribe-style` to persist metadata

### 2) Persist the style slot metadata in the profile

**PUT** `/profiles/me/scribe-style`

Request body:

```json
{
  "slot": 1,
  "file_route": "users/<userId>/rubrics/2025/10/<uuid>-scribe-style-slot-1-style-example.pdf",
  "mimeType": "application/pdf",
  "originalFilename": "style-example.pdf"
}
```

Response (200):

```json
{ "success": true }
```

---

## Scribe: Rubric Upload

### Generate presigned upload URL for rubric file

**POST** `/scribe/upload-url`

Request body:

```json
{
  "fileName": "rubric.pdf",
  "contentType": "application/pdf",
  "sizeBytes": 2500000
}
```

Response (200):

```json
{
  "signedUrl": "https://...",
  "key": "users/<userId>/rubrics/2025/10/<uuid>-rubric.pdf"
}
```

Client steps:
- `PUT signedUrl` with `Content-Type: contentType`
- then pass `rubricFileR2Key = key` and `rubricMimeType = contentType` to `POST /scribe`

---

## Scribe: Answer Image Upload (for form fields `image_file`)

### Generate presigned upload URL for an answer image

**POST** `/scribe/projects/{id}/answer-upload-url`

Request body:

```json
{
  "questionId": "q_screenshot_1",
  "fileName": "screenshot.png",
  "contentType": "image/png",
  "sizeBytes": 500000
}
```

Response (200):

```json
{
  "signedUrl": "https://...",
  "file_route": "users/<userId>/rubrics/2025/10/<uuid>-q_screenshot_1-screenshot.png"
}
```

Client steps:
- `PUT signedUrl` with `Content-Type: contentType`
- then answer the form using:

```json
{
  "q_screenshot_1": {
    "file_route": "users/<userId>/rubrics/2025/10/<uuid>-q_screenshot_1-screenshot.png",
    "mimeType": "image/png"
  }
}
```

---

## Scribe: Iteration Endpoint

### Run one iteration

**POST** `/scribe`

Request body (create new project):

```json
{
  "title": "Ensayo final",
  "templateId": "apa",
  "rubricContent": "..." 
}
```

Or create with rubric file reference:

```json
{
  "title": "Ensayo final",
  "templateId": "apa",
  "rubricFileR2Key": "users/<userId>/rubrics/2025/10/<uuid>-rubric.pdf", 
  "rubricMimeType": "application/pdf"
}
```

Request body (continue an existing project):

```json
{
  "projectId": "<scribeProjectId>",
  "userAnswers": {
    "q1": "...",
    "q_screenshot_1": { "file_route": "users/<userId>/rubrics/2025/10/<uuid>-q_screenshot_1-screenshot.png", "mimeType": "image/png" }
  }
}
```

Response when the agent needs more input (200):

```json
{
  "kind": "form",
  "projectId": "<scribeProjectId>",
  "status": "needs_input",
  "form": {
    "form_title": "...",
    "estimated_time": "...",
    "sections": [
      {
        "section_title": "...",
        "questions": [
          {
            "id": "q1",
            "type": "text",
            "label": "...",
            "help_text": "...",
            "required": true
          },
          {
            "id": "q_screenshot_1",
            "type": "image_file",
            "label": "...",
            "help_text": "...",
            "required": true
          }
        ]
      }
    ]
  }
}
```

Response when the agent can generate the final result (200):

```json
{
  "kind": "result",
  "projectId": "<scribeProjectId>",
  "status": "blocked",
  "finalPdfR2Key": "users/<userId>/scribe/<projectId>/generated.pdf",
  "exam": {
    "questions": [
      {
        "id": "q1",
        "prompt": "...",
        "options": { "a": "...", "b": "...", "c": "...", "d": "..." },
        "correct": "b"
      }
    ]
  }
}
```

Notes:
- `status="blocked"` is UX-only gating. Use `GET /scribe/{id}/pdf` to get a temporary URL.

---

## Scribe: Read APIs

### List projects

**GET** `/scribe`

Response:

```json
{ "projects": [ { "id": "...", "status": "needs_input", "formSchema": { } } ] }
```

### Get a project

**GET** `/scribe/{id}`

Response (example):

```json
{
  "id": "...",
  "userId": "...",
  "templateId": "apa",
  "title": "...",
  "status": "blocked",
  "rubricContent": null,
  "rubricFileR2Key": "users/<userId>/rubrics/2025/10/<uuid>-rubric.pdf",
  "rubricMimeType": "application/pdf",
  "formSchema": null,
  "userAnswers": { },
  "exam": { "questions": [] },
  "finalPdfR2Key": "users/<userId>/scribe/<projectId>/generated.pdf",
  "createdAt": "...",
  "updatedAt": "..."
}
```

---

## Scribe: Get PDF URL (On-Demand)

### Generate temporary presigned URL to view the PDF

**GET** `/scribe/{id}/pdf`

Returns a presigned URL valid for **1 hour** to download/view the generated PDF.

Response (200):

```json
{
  "pdfUrl": "https://...",
  "expiresInSeconds": 3600
}
```

Errors:
- `404` if project not found or PDF not generated yet

Client workflow:
1. Check project status is `blocked` or `available`
2. Call `GET /scribe/{id}/pdf` to get temporary URL
3. Use `pdfUrl` immediately (valid for 1 hour)
4. If URL expires, request a new one

---

## Scribe: Unlock

### Unlock the PDF

**POST** `/scribe/{id}/unlock_pdf`

Response (200):

```json
{ "success": true }
```

---

## Error format

Errors are returned as:

```json
{ "error": "..." }
```
